<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualizing CSSE at Johns Hopkins University's Data</title>
    <style>
        section {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        div {
            display: flex;
            flex-direction: row;
            min-height: 200px;
            align-items: flex-end;
            justify-content: space-evenly;
            border: 1px solid #ddd;
            margin-bottom: 50px;
            margin-right: 30px;
            padding: 5px;
            position: relative;

        }

        span {
            width: 2px;
            display: flex;
            margin-right: 1px;
            background: orange;
            height: 0;
            align-items: center;
            justify-content: center;

        }

        div:first-of-type {
            display: none;
        }

        section div:first-of-type {
            display: flex;
        }


        span:first-child {
            position: absolute;
            bottom: -40px;
            left: 0;
            background: gray;
            color: white;
            width: 100%;
            height: 40px;
            text-align: center;
        }

        main {
            display: flex;
            padding: 5px;

        }

        select {
            margin: 5px;
        }


        input {
            padding: 5px;
        }

        span.empty {
            background: #fefefe !important;
        }

        span.deaths {
            background: #ff0000 !important;
        }

        span.recovered {
            background: #0000FF !important;
        }

    </style>
</head>
<body>
<main>
    <ul>
        <li><label for="Country">Country
            <input name="Country" id="country" value="Canada" type="text"/>
        </label></li>
        <li><label for="Scale">Scale </label>
            <input type="range" name="Scale" id="scale" value="2" min="0.02" max="4" step="0.02"/></li>
<!--        <li><label for="confirmed">Confirmed-->
<!--            <input type="checkbox" checked="checked" disabled id="confirmed" name="confirmed"/>-->
<!--        </label></li>-->
<!--        <li><label for="deaths">Deaths-->
<!--            <input type="checkbox" id="deaths" name="deaths"/>-->
<!--        </label></li>-->
<!--        <li><label for="recovered">Recovered-->
<!--            <input type="checkbox" id="recovered" name="recovered"/>-->
<!--        </label></li>-->

<!--        <li><label for="log">Log10-->
<!--            <input type="radio" id="log" name="type"/></label>-->
<!--            <label for="unit">Unit-->
<!--                <input type="radio" id="unit" name="type"/>-->
<!--            </label><label for="percent">Percent-->
<!--                <input type="radio" id="percent" name="type"/>-->
<!--            </label></li>-->

    </ul>
</main>
<section>
</section>
<script>

    class Graph {
        constructor() {
            this.all = {}
            this.section = document.querySelector('section')
            this.confirmed = `time_series_19-covid-Confirmed.csv`
            this.deaths = `time_series_19-covid-Deaths.csv`
            this.recovered = `time_series_19-covid-Recovered.csv`

            // this.dinput = document.querySelector('#deaths')
            // this.dinput.addEventListener('change', () => this.getValues())

            // this.rinput = document.querySelector('#recovered')
            // this.rinput.addEventListener('change', () => this.getValues())

            this.country = document.querySelector('#country')
            this.country.addEventListener('change', () => this.getValues())

            this.scale = document.querySelector('#scale')
            this.scale.addEventListener('change', () => this.getValues())
            this.getValues()
        }

        async fetchValues(file, type) {
            try {
                await fetch(file)
                    .then(response => {
                        if (!response.ok) throw Error(response.statusText)
                        return response.text()
                    })
                    .then(async data => {
                        this.all = {}
                        this.section.innerHTML = ""

                        data.split(/[\n\r|\r|\n\r|\n]/gi).map(line => {
                            const val = line.replace(`, `, ` `).replace(/"/gi, ``).split(`,`)
                            if (val[1] === this.country.value) this.all[val[0]] = [val.slice(4), val[1]]
                        })

                    }).then(() => this.showValues(type));
            } catch (err) {
                console.log({err})
                return false
            }
        }

        async getValues(file) {
            const files = [this.confirmed]
            files.forEach((a, b) => {
                this.fetchValues(a, b)
            })

        }

        async showValues(type) {
            Object.entries(this.all).map(([a, b],divnum) => {
                let prevDiv
                let div = document.createElement('div')
                let span = document.createElement('span')

                span.innerHTML = `${b[1]} - ${a}`

                div.appendChild(span)
                b[0].forEach((c, d, e) => {
                    let prev
                    let bar = document.createElement('span')
                    let g = Math.log10(parseFloat(e[d + 1]) / parseFloat(c)) * 100
                    g = isNaN(g) ? 0 : g.toFixed(2)
                    g = !isFinite(parseFloat(g)) ? 0 : g
                    if (g > 0) {
                        if (type > 0) {
                            prevDiv = document.querySelectorAll('div')
                            console.log(prevDiv)
                        }
                        if (type === 1) {
                            bar.classList.add('deaths')
                        } else if (type === 2) {
                            bar.classList.add('recovered')
                        }
                        bar.style.height = parseFloat(g) * parseFloat(this.scale.value) + "px"

                    } else {
                        bar.classList.add('empty')
                    }

                    div.style.width = 210 + (3 * b.length) + "px";
                    div.appendChild(bar)

                })
                this.section.appendChild(div)
            })
        }
    }

    const graph = new Graph()
</script>
</body>
</html>