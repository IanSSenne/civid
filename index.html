<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualizing CSSE at Johns Hopkins University's Data</title>
    <style>
        section {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        div {
            display: flex;
            flex-direction: row;
            min-height: 200px;
            align-items: flex-end;
            justify-content: space-evenly;
            border: 1px solid #ddd;
            margin-bottom: 50px;
            margin-right: 30px;
            padding: 5px;
            position: relative;

        }

        span {
            width: 2px;
            display: flex;
            background: orange;
            height: 0;
            align-items: center;
            justify-content: center;

        }

        div:first-of-type {
            display: none;
        }

        section div:first-of-type {
            display: flex;
        }


        span:first-child {
            position: absolute;
            bottom: -40px;
            left: 0;
            background: gray;
            color: white;
            width: 100%;
            height: 40px;
            text-align: center;
        }

        main {
            display: flex;
            padding: 5px;

        }

        select {
            margin: 5px;
        }


        input {
            padding: 5px;
        }

        span.empty {
            /*background: red !important;*/
            height: 0;
        }

        .deaths {
            background: #ff0000 !important;
        }

        .recovered {
            background: #0000FF !important;
        }

    </style>
</head>
<body>
<main>
    <ul>
        <li><label for="Country">Country
            <input name="Country" id="country" value="Canada" type="text"/>
        </label></li>




        <li><label for="totals">Totals
            <input type="radio" id="totals" name="unit"/></label>
            <label for="change">Change
                <input type="radio" id="change" name="unit"/>
            </label><label for="growth">Growth Factor
                <input type="radio" id="growth" name="unit"/>
            </label></li>

    </ul>
</main>
<section>
</section>
<script>

    class Graph {
        constructor() {
            this.all = {}
            this.section = document.querySelector('section')
            this.confirmed = `time_series_19-covid-Confirmed.csv`
            this.deaths = `time_series_19-covid-Deaths.csv`
            this.recovered = `time_series_19-covid-Recovered.csv`

            this.dinput = document.querySelector('#deaths')
            this.rinput = document.querySelector('#recovered')
            this.cinput = document.querySelector('#country')

            this.tinput = document.querySelector('#totals')
            this.chinput = document.querySelector('#change')
            this.ginput = document.querySelector('#growth')

            const inputs = ["c","t", "ch", "g"].forEach(val =>
                this[`${val}input`].addEventListener('change', () => this.init()))
            const types = ["confirmed","deaths"].forEach(a => this.all[a] = [])



            this.init()




        }
        async init(){
            this.section.innerHTML = ""
            const data = await this.getValues([this.deaths,this.confirmed])
            this.showValues(data)

        }

        async getValues(data, newdata) {
            newdata = newdata || []
            if(data.length) {
                const d = data.pop()
                await this.fetchValues(d).then(async da =>{
                    newdata.push(this.formatData(this.splitData(da)))
                    return await this.getValues(data,newdata)
                })
            }
            return await newdata
        }




        splitData(data) {
            return data.split(/[\n\r|\r|\n\r|\n]/gi)
        }

         formatData(data) {
            if(data) {
                return data.map(line => {
                    if (line) {
                        line = line.replace(`, `, ` `).replace(/"/gi, ``).split(`,`)
                        return (line[1].toLowerCase() === this.cinput.value.toLowerCase())
                            ? [
                                line[1],
                                line[0],
                                line.slice(4),
                                line.slice(4).reduce((a,b,c,d)=>{
                                    let e = parseInt(d[c+1])-parseInt(b)
                                    e = isNaN(e) ? 0 : e
                                    return e + parseInt(a)
                                })
                            ]
                            : []
                    }
                }).filter(a=>(a && a.length))
            }
        }

        fetchValues(file) {
            try {
                return fetch(file)
                    .then(response => {
                        if (!response.ok) throw Error(response.statusText)
                        return response.text()
                    })

            } catch (err) {
                console.log({err})
                return false
            }
        }


        showValues(data) {



            const test = data[0].map((a,b)=> [a,data[data.length-1][b]])

                Object.values(test).map((b,f) => {

                    let div = document.createElement('div')
                    let span = document.createElement('span')

                    span.innerHTML = `${b[0][1]} - ${b[0][0]} <br> C:${b[0][3]} D:${data[1][f][3]}`
                    div.appendChild(span)

                    //    Day
                    b[1][2].forEach((c, d, e) => {
                        let bar = document.createElement('span')
                        let bar2 = document.createElement('span')

                        // let bar2 = document.createElement('span')
                        // let i = Math.abs(parseFloat(e[d + 1]) - parseFloat(c))/Math.abs(parseFloat(c) - parseFloat(e[d - 1]))
                        // let i = parseFloat(c) - parseFloat(e[d - 1])

                        let i = b[0][2][d]
                        let j = data[1][f][2][d]
                        console.log(i,j)


                        // console.log(`j: ${j}, k: ${k}`)
                        // let j = c

                        // i = (!isNaN(i) && isFinite(i)) ? i : false
                        // if (i) {
                        bar2.style.height = i/5 + "px"
                        bar.style.height = j/5 + "px"

                        // bar2.style.height = Math.log(j)*10 + "px"

                        // } else {
                        //     bar.classList.add('empty')
                        // }
                        bar.classList.add('deaths')

                        // div.style.width = 210 + (3 * b.length) + "px";
                        div.appendChild(bar)
                        div.appendChild(bar2)
                        // bar.append(bar2)

                    })
                    this.section.appendChild(div)
                })




        }
    }

    const graph = new Graph()
</script>
</body>
</html>